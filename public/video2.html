<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Video Call Receiver</title>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: Arial;
        background: #111;
        color: white;
        height: 100vh;
        overflow: hidden;
        position: relative;
      }

      #remoteVideo {
        width: 100%;
        height: calc(100vh - 120px);
        object-fit: cover;
        background: black;
      }
      #localVideo {
        position: absolute;
        top: 20px;
        right: 20px;
        width: 180px;
        height: 120px;
        border-radius: 12px;
        border: 2px solid #25d366;
        object-fit: cover;
        z-index: 10;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.7);
      }

      #controls {
        position: absolute;
        bottom: 20px;
        width: 100%;
        display: flex;
        justify-content: center;
        gap: 20px;
        z-index: 10;
      }
      button {
        padding: 14px 22px;
        border: none;
        border-radius: 50%;
        font-size: 18px;
        cursor: pointer;
        color: white;
        transition: transform 0.2s;
      }
      button:hover {
        transform: scale(1.1);
      }
      #toggleCam {
        background: #25d366;
      }
      #toggleMic {
        background: #ffa500;
      }
      #hangup {
        background: #c63636;
      }

      #popup {
        position: fixed;
        inset: 0;
        display: none;
        background: rgba(0, 0, 0, 0.85);
        align-items: center;
        justify-content: center;
        z-index: 20;
      }
      .popup-box {
        background: #121217;
        padding: 30px 40px;
        border-radius: 16px;
        text-align: center;
        box-shadow: 0 0 25px rgba(0, 0, 0, 0.7);
      }
      .popup-box p {
        font-size: 1.4rem;
        margin-bottom: 20px;
      }
      .popup-box button {
        padding: 12px 24px;
        font-size: 16px;
        border-radius: 10px;
        border: none;
        cursor: pointer;
        margin: 0 10px;
      }
      #acceptBtn {
        background: #25d366;
        color: white;
      }
      #declineBtn {
        background: #c63636;
        color: white;
      }

      #statusEl {
        position: absolute;
        top: 20px;
        left: 20px;
        font-size: 16px;
        color: #aaa;
        z-index: 10;
      }
    </style>
  </head>
  <body>
    <div id="statusEl">Waiting...</div>
    <video id="remoteVideo" autoplay playsinline></video>
    <video id="localVideo" autoplay playsinline muted></video>

    <div id="controls">
      <button id="toggleCam">ðŸŽ¥</button>
      <button id="toggleMic">ðŸŽ¤</button>
      <button id="hangup">ðŸ“ž</button>
    </div>

    <div id="popup">
      <div class="popup-box">
        <p>ðŸ“ž Incoming Call</p>
        <button id="acceptBtn">Accept</button>
        <button id="declineBtn">Decline</button>
      </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();
      let pc = null;
      let localStream = null;
      let remoteStream = null;
      let pendingOffer = null;
      let candidateQueue = []; // queue ICE candidates before PC exists

      const room =
        new URLSearchParams(window.location.search).get("room") || "room1";

      const statusEl = document.getElementById("statusEl");
      const localVideo = document.getElementById("localVideo");
      const remoteVideo = document.getElementById("remoteVideo");
      const popup = document.getElementById("popup");
      const acceptBtn = document.getElementById("acceptBtn");
      const declineBtn = document.getElementById("declineBtn");
      const toggleCamBtn = document.getElementById("toggleCam");
      const toggleMicBtn = document.getElementById("toggleMic");
      const hangupBtn = document.getElementById("hangup");

      const ICE_CONFIG = {
        iceServers: [{ urls: "stun:stun.l.google.com:19302" }],
      };
      const ringtone = new Audio("/mediafiles/ring1.mp3");
      ringtone.loop = true;

      socket.emit("join-room", room);

      // --- Local stream helper ---
      async function ensureLocalStream() {
        if (!localStream) {
          try {
            localStream = await navigator.mediaDevices.getUserMedia({
              video: true,
              audio: true,
            });
            localVideo.srcObject = localStream;
            return true;
          } catch (err) {
            console.error(err);
            statusEl.textContent = "Camera/mic access denied âŒ";
            return false;
          }
        }
        return true;
      }

      // --- Create peer connection ---
      function createPeerConnection() {
        pc = new RTCPeerConnection(ICE_CONFIG);

        pc.ontrack = (e) => {
          if (!remoteStream) {
            remoteStream = new MediaStream();
            remoteVideo.srcObject = remoteStream;
          }
          remoteStream.addTrack(e.track);
          statusEl.textContent = "Connected ðŸŽ¥";
        };

        pc.onicecandidate = (e) => {
          if (e.candidate) {
            socket.emit("ice-candidate", { room, candidate: e.candidate });
          }
        };

        pc.oniceconnectionstatechange = () => {
          if (
            pc.iceConnectionState === "disconnected" ||
            pc.iceConnectionState === "failed"
          ) {
            statusEl.textContent = "Connection lost ðŸ”Œ";
          }
        };

        // Process any queued ICE candidates
        candidateQueue.forEach(async (c) => {
          try {
            await pc.addIceCandidate(new RTCIceCandidate(c));
          } catch (err) {
            console.warn("Failed to add queued candidate:", err);
          }
        });
        candidateQueue = [];
      }

      // --- Accept call ---
      async function acceptCall() {
        popup.style.display = "none";
        ringtone.pause();
        statusEl.textContent = "Accepting call...";
        if (!(await ensureLocalStream())) return;

        createPeerConnection();
        localStream.getTracks().forEach((t) => pc.addTrack(t, localStream));
        await pc.setRemoteDescription(new RTCSessionDescription(pendingOffer));
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        socket.emit("video-answer", { room, answer });
        pendingOffer = null;
      }

      // --- Decline call ---
      function declineCall() {
        popup.style.display = "none";
        ringtone.pause();
        pendingOffer = null;
        socket.emit("call-declined", { room });
        statusEl.textContent = "Call declined âŒ";
      }

      // --- Hangup ---
      function hangupCall() {
        if (pc) pc.close();
        if (localStream) localStream.getTracks().forEach((t) => t.stop());
        if (remoteStream) remoteStream.getTracks().forEach((t) => t.stop());
        pc = localStream = remoteStream = null;
        localVideo.srcObject = remoteVideo.srcObject = null;
        statusEl.textContent = "Call ended âŒ";
        popup.style.display = "none";
        socket.emit("user-left", { room });
      }

      // --- Buttons ---
      toggleCamBtn.onclick = () => {
        if (!localStream) return;
        localStream.getVideoTracks().forEach((t) => (t.enabled = !t.enabled));
        toggleCamBtn.style.opacity = localStream.getVideoTracks()[0].enabled
          ? "1"
          : "0.5";
      };
      toggleMicBtn.onclick = () => {
        if (!localStream) return;
        localStream.getAudioTracks().forEach((t) => (t.enabled = !t.enabled));
        toggleMicBtn.style.opacity = localStream.getAudioTracks()[0].enabled
          ? "1"
          : "0.5";
      };
      hangupBtn.onclick = hangupCall;
      acceptBtn.onclick = acceptCall;
      declineBtn.onclick = declineCall;

      // --- Socket events ---
      socket.on("video-offer", ({ offer }) => {
        pendingOffer = offer;
        ringtone.currentTime = 0;
        ringtone.play();
        popup.style.display = "flex";
        statusEl.textContent = "Incoming call... ðŸ“ž";
      });

      socket.on("video-answer", async ({ answer }) => {
        if (pc)
          await pc.setRemoteDescription(new RTCSessionDescription(answer));
        statusEl.textContent = "Connected ðŸŽ¥";
      });

      socket.on("ice-candidate", async ({ candidate }) => {
        if (!pc) {
          console.log("Queueing ICE candidate until accept...");
          candidateQueue.push(candidate);
        } else {
          await pc.addIceCandidate(new RTCIceCandidate(candidate));
        }
      });

      socket.on("user-left", hangupCall);
      socket.on("call-declined", hangupCall);

      window.addEventListener("beforeunload", hangupCall);
    </script>
  </body>
</html>
